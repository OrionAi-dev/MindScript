# SpecFlow Mapper

This adapter connects OpenSpec `@software` criteria to **SpecFlow** by **referencing external artifacts only**. It does **not** embed or generate Gherkin or C# step code from OpenSpec. Instead, it verifies links to SpecFlow `.feature` files and `Scenario`s you reference, and produces a traceability index.

## Design principles

- **OpenSpec stays agnostic.** We only link to SpecFlow; no Gherkin or C# semantics live in the OpenSpec schema.
- **References over generation.** The mapper verifies and indexes your references; it does not author `.feature` files or step bindings.
- **Profiles by URL.** `bdd_ref.source` must be a URL listed in `bdd-registry.yaml` (e.g., SpecFlow).

## What it does

- Reads an OpenSpec YAML that declares:
  - `profile: https://openspec.dev/profiles/@software`
  - One or more criteria with `bdd_ref` pointing to SpecFlow artifacts
- For each criterion with `bdd_ref`:
  - Validates `bdd_ref.source` matches the SpecFlow profile URL from your registry
  - Resolves `bdd_ref.path` to a `.feature` (local file or URL)
  - Confirms the named `bdd_ref.scenario` exists in that file
  - Records the linkage in `dist/specflow/index.json` for traceability
- Optionally copies the referenced `.feature` files into `dist/specflow/features/` **without modification** for distribution

## Inputs (required fields)

- `criteria[].bdd_ref.source` → SpecFlow profile URL  
  Example: `https://openspec.dev/profiles/bdd/specflow`
- `criteria[].bdd_ref.path` → path/URL to the `.feature`
- `criteria[].bdd_ref.scenario` → scenario name inside that feature

> Note: Inline step fields such as `given`, `when`, `then` are **not used**. The mapper ignores them if present.

## Minimal example (OpenSpec → SpecFlow reference)

OpenSpec input:

```yaml
profile: https://openspec.dev/profiles/@software
kind: software
meta:
  id: SPECFLOW-201
  title: User login with SpecFlow
  owner: app-auth
  priority: P1
  labels: [specflow, dotnet]

requirements:
  - id: SPECFLOW-201.1
    statement: SpecFlow scenario is bound to C# steps
    criteria:
      - id: SPECFLOW-201.1.1
        type: functional
        text: SpecFlow scenario is executable
        bdd_ref:
          source: https://openspec.dev/profiles/bdd/specflow
          path: ./SPECFLOW-LOGIN.feature
          scenario: Valid credentials produce a successful session
```

SpecFlow feature (referenced, maintained in your repo; **not generated by the mapper**):

```gherkin
Feature: SPECFLOW-201 User login with SpecFlow
  @openspec(SPECFLOW-201.1.1)
  Scenario: Valid credentials produce a successful session
    Given a registered user with a verified email
    When the user submits valid credentials
    Then the app creates a session and redirects to the dashboard
```

Mapper output (traceability index):

```json
{
  "profile": "https://openspec.dev/profiles/@software",
  "tool": "specflow",
  "mappings": [
    {
      "criteria_id": "SPECFLOW-201.1.1",
      "feature": "docs/mindscript/implementations/@software/examples/SPECFLOW-LOGIN.feature",
      "scenario": "Valid credentials produce a successful session"
    }
  ]
}
```

## Field mapping (reference-only)

OpenSpec → SpecFlow

- `meta.id`, `meta.title` → used for discovery and file naming; **no content is generated**
- `requirements[].id`, `requirements[].statement` → used for grouping in the index
- `criteria[].id`, `criteria[].text` → used for index entries
- `criteria[].bdd_ref.source` → must match the SpecFlow profile URL in `bdd-registry.yaml`
- `criteria[].bdd_ref.path` → `.feature` file location
- `criteria[].bdd_ref.scenario` → Scenario name within that `.feature`

## File layout

**Inputs**
- OpenSpec specs: anywhere (examples under `docs/mindscript/implementations/@software/examples/`)
- SpecFlow features: usually under `Features/` in your .NET test project; examples live alongside the YAML

**Outputs**
- Traceability index → `dist/specflow/index.json`
- Optional copied features (unchanged) → `dist/specflow/features/`

## Validation rules applied

- OpenSpec file must validate against `@software` schema
- `bdd_ref.source` must be a URL listed under SpecFlow in `bdd-registry.yaml`
- `bdd_ref.path` must resolve to an existing `.feature` (local or reachable URL)
- `bdd_ref.scenario` must exist in the target `.feature`
- Inline step fields are ignored; OpenSpec does **not** define steps

## Naming guidance

- If features are copied, default filename is `<meta.id>.feature` unless a collision occurs; then the original filename is preserved
- Index keys use `criteria.id` as the stable identifier

## Integration tips

- Place step bindings under `StepDefinitions/` with `[Binding]` and `[Given]/[When]/[Then]` attributes
- Useful commands:
  - `dotnet test` to execute SpecFlow scenarios as part of your test project
  - SpecFlow LivingDoc (if you use it) can consume your `.feature` files for docs
- Tag scenarios with OpenSpec IDs for back-references (as shown above), or use C# category attributes on test runners if applicable

## Limitations

- The mapper does **not** generate or modify `.feature` content or C# step definitions
- It does not handle authenticated remote URLs unless your CLI adds credentials
- Assumes UTF-8 and standard Gherkin keywords

## Quick checklist

- [ ] OpenSpec YAML validates against `@software` schema  
- [ ] `bdd-registry.yaml` includes the SpecFlow profile URL  
- [ ] External `.feature` file exists and contains the named Scenario  
- [ ] `dist/specflow/index.json` produced for traceability  
- [ ] (Optional) Features copied to `dist/specflow/features/` without modification
