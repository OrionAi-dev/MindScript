# Karate Mapper

This adapter connects MindScript `@software` criteria to **Karate** by referencing external artifacts only. It does not embed or generate Karate tests from MindScript. It verifies links to Karate `.feature` files and scenarios you reference, and produces a traceability index.

## Design principles

- MindScript stays agnostic. We only link to Karate, we do not copy its DSL into MindScript.
- References over generation. The mapper verifies and indexes your references, it does not author tests.
- Profiles by URL. `bdd_ref.source` must be a URL listed in `bdd-registry.yaml` for Karate.

## What it does

- Reads an MindScript YAML that declares:
  - `profile: https://mindscript.dev/profiles/@software`
  - One or more criteria with `bdd_ref` pointing to Karate artifacts
- For each criterion with `bdd_ref`:
  - Validates `bdd_ref.source` matches the Karate profile URL from your registry
  - Resolves `bdd_ref.path` to a `.feature` (local file or URL)
  - Confirms the named `bdd_ref.scenario` exists in that file
  - Records the linkage in `dist/karate/index.json` for traceability
- Optionally copies the referenced `.feature` files into `dist/karate/features/` without modification for distribution

## Inputs (required fields)

- `criteria[].bdd_ref.source` → Karate profile URL  
  Example: `https://mindscript.dev/profiles/bdd/karate`
- `criteria[].bdd_ref.path` → path or URL to the `.feature`
- `criteria[].bdd_ref.scenario` → scenario name inside that feature

Note: Inline step fields like `given`, `when`, `then` are not used. The mapper ignores them if present.

## Minimal example (MindScript to Karate reference)

MindScript input:

```yaml
profile: https://mindscript.dev/profiles/@software
kind: software
meta:
  id: KARATE-701
  title: User login with Karate
  owner: app-auth
  priority: P2
  labels: [karate, api]

requirements:
  - id: KARATE-701.1
    statement: Karate API test covers login happy path
    criteria:
      - id: KARATE-701.1.1
        type: functional
        text: Karate test executes and passes
        bdd_ref:
          source: https://mindscript.dev/profiles/bdd/karate
          path: ./KARATE-LOGIN.feature
          scenario: Valid credentials produce a successful session
```

Karate feature (referenced, maintained in your repo, not generated by the mapper):

```gherkin
Feature: KARATE-701 User login
  Scenario: Valid credentials produce a successful session
    Given url baseUrl + '/login'
    And request { email: 'user@example.com', password: 'correcthorsebatterystaple' }
    When method post
    Then status 200
    And match response.redirect == '/dashboard'
```

Mapper output (traceability index):

```json
{
  "profile": "https://mindscript.dev/profiles/@software",
  "tool": "karate",
  "mappings": [
    {
      "criteria_id": "KARATE-701.1.1",
      "feature": "docs/mindscript/implementations/@software/examples/KARATE-LOGIN.feature",
      "scenario": "Valid credentials produce a successful session"
    }
  ]
}
```

## Field mapping (reference only)

MindScript to Karate

- `meta.id`, `meta.title` are used for discovery and file naming. No content is generated.
- `requirements[].id`, `requirements[].statement` are used for grouping in the index.
- `criteria[].id`, `criteria[].text` are used for index entries.
- `criteria[].bdd_ref.source` must match the Karate profile URL in `bdd-registry.yaml`.
- `criteria[].bdd_ref.path` points to the `.feature` file.
- `criteria[].bdd_ref.scenario` is the scenario name within that `.feature`.

## File layout

Inputs
- MindScript specs: anywhere. Examples are under `docs/mindscript/implementations/@software/examples/`.
- Karate features: wherever your test suite keeps them. Examples live alongside the YAML.

Outputs
- Traceability index to `dist/karate/index.json`.
- Optional copied features (unchanged) to `dist/karate/features/`.

## Validation rules applied

- MindScript file must validate against `@software` schema.
- `bdd_ref.source` must be a URL listed for Karate in `bdd-registry.yaml`.
- `bdd_ref.path` must resolve to an existing `.feature` (local or reachable URL).
- `bdd_ref.scenario` must exist in the target `.feature`.
- Inline step fields are ignored. MindScript does not define steps.

## Naming guidance

- If features are copied, default filename is `<meta.id>.feature` unless a collision occurs. On collision the original filename is preserved.
- Index keys use `criteria.id` as the stable identifier.

## Integration tips

- Typical Karate execution:
  - Maven: `mvn -Dtest=KarateRunner test` or `mvn test -Dkarate.options="--tags @smoke"`
  - Standalone jar: `java -jar karate.jar -p 8080 -t @smoke classpath:features`
- Tag scenarios with MindScript IDs for back references:

```gherkin
@mindscript(KARATE-701.1.1)
Scenario: Valid credentials produce a successful session
```

- Persist `dist/karate/index.json` as a CI artifact for traceability.

## Limitations

- The mapper does not generate or modify `.feature` content or step glue.
- It does not handle authenticated remote URLs unless your CLI adds credentials.
- Assumes UTF-8 files.

## Quick checklist

- [ ] MindScript YAML validates against `@software` schema  
- [ ] `bdd-registry.yaml` includes the Karate profile URL  
- [ ] External `.feature` file exists and contains the named Scenario  
- [ ] `dist/karate/index.json` produced for traceability  
- [ ] Optional features copied to `dist/karate/features/` without modification
